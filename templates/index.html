<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comparaci√≥n de Precios - Dialfa</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .card-value small {
            font-size: 16px;
            opacity: 0.8;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }
        
        input[type="number"] {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .config-panel {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #f39c12;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .config-panel h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 700;
        }
        
        .config-panel .info-text {
            margin-top: 12px;
            font-size: 12px;
            color: #5a4a42;
            background-color: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .errors {
            background-color: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .errors h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .errors ul {
            margin-left: 20px;
            color: #c0392b;
        }
        
        table.dataTable {
            width: 100% !important;
            font-size: 13px;
        }
        
        table.dataTable thead th {
            background-color: #34495e;
            color: white;
            padding: 12px 8px;
            font-weight: 600;
        }
        
        table.dataTable tbody td {
            padding: 10px 8px;
        }
        
        table.dataTable tbody tr:hover {
            background-color: #ecf0f1;
        }
        
        .margin-low {
            background-color: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .margin-medium {
            background-color: #fff8e1 !important;
            color: #f57c00;
            font-weight: bold;
        }
        
        .margin-high {
            background-color: #e8f5e9 !important;
            color: #2e7d32;
            font-weight: bold;
        }
        
        .price {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .position-cheapest {
            color: #27ae60;
            font-weight: bold;
        }
        
        .position-expensive {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .position-middle {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Sistema de Comparaci√≥n de Precios</h1>
        <p class="subtitle">Comparaci√≥n integral: Dialfa vs Citizen (Proveedor) vs Competencia (Cintolo, Zaloze)</p>
        
        <div id="errors-container"></div>
        
        <div class="summary-cards" id="summary-cards">
            <div class="card">
                <div class="card-title">Total Productos Dialfa</div>
                <div class="card-value" id="total-products">-</div>
            </div>
            <div class="card green">
                <div class="card-title">‚úì Match Citizen</div>
                <div class="card-value" id="matched-products">-</div>
            </div>
            <div class="card orange">
                <div class="card-title">‚úó Sin Match Citizen</div>
                <div class="card-value" id="unmatched-citizen">-</div>
            </div>
            <div class="card blue">
                <div class="card-title">Margen Promedio</div>
                <div class="card-value" id="avg-margin">-<small>%</small></div>
            </div>
        </div>
        
        <div class="summary-cards" style="margin-bottom: 30px;">
            <div class="card" style="background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);">
                <div class="card-title">‚úì Match Cintolo</div>
                <div class="card-value" id="matched-cintolo">-</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">
                <div class="card-title">‚úó Sin Match Cintolo</div>
                <div class="card-value" id="unmatched-cintolo">-</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);">
                <div class="card-title">‚úì Match Zaloze</div>
                <div class="card-value" id="matched-zaloze">-</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%); color: #333;">
                <div class="card-title">‚úó Sin Match Zaloze</div>
                <div class="card-value" id="unmatched-zaloze">-</div>
            </div>
        </div>
        
        <div class="config-panel">
            <h3>‚öôÔ∏è Configuraci√≥n de Precios</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div class="filter-group">
                    <label>Descuento Universal (%)</label>
                    <input type="number" id="discount-percent" value="30" min="0" max="100" step="1"
                           title="Porcentaje de descuento aplicado a TODOS los productos (0 = sin descuento)">
                    <small style="color: #6c757d; font-size: 11px; margin-top: 5px; display: block;">
                        Se aplica a todo el cat√°logo. Ejemplo: 30% ‚Üí todos los precios √ó 0.70
                    </small>
                </div>
                <div class="filter-group">
                    <label>Nacionalizaci√≥n (%)</label>
                    <input type="number" id="nationalization-percent" value="150" min="0" step="1"
                           title="Porcentaje de incremento para nacionalizar precios FOB">
                    <small style="color: #6c757d; font-size: 11px; margin-top: 5px; display: block;">
                        Costos de importaci√≥n. Ejemplo: 150% ‚Üí FOB √ó 2.5
                    </small>
                </div>
                <div class="filter-group">
                    <label>Descuento Cintolo (%)</label>
                    <input type="number" id="cintolo-discount" value="20" min="0" max="100" step="1"
                           title="Porcentaje de descuento aplicado a precios de Cintolo">
                    <small style="color: #6c757d; font-size: 11px; margin-top: 5px; display: block;">
                        Descuento sobre lista Cintolo. Ejemplo: 20% ‚Üí precio √ó 0.80
                    </small>
                </div>
                <div class="filter-group">
                    <label>Descuento Zaloze (%)</label>
                    <input type="number" id="zaloze-discount" value="20" min="0" max="100" step="1"
                           title="Porcentaje de descuento aplicado a precios de Zaloze">
                    <small style="color: #6c757d; font-size: 11px; margin-top: 5px; display: block;">
                        Descuento sobre lista Zaloze. Ejemplo: 20% ‚Üí precio √ó 0.80
                    </small>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="applyPricingConfig()" style="width: 100%; background-color: #e67e22; font-weight: 600; height: 45px;">
                        üí∞ Aplicar Configuraci√≥n
                    </button>
                </div>
            </div>
            <p class="info-text">
                üí° <strong>Descuento Universal:</strong> Se aplica a TODOS los productos Dialfa (0% = sin descuento). 
                <strong>Nacionalizaci√≥n:</strong> Incremento (%) sobre precio FOB de Citizen para costos de importaci√≥n.
                <strong>Descuentos Cintolo/Zaloze:</strong> Descuentos sobre las listas de precios de competidores.
                <br>
                üìä Los m√°rgenes se calculan usando el precio final (con descuento si > 0%) y el precio nacionalizado.
            </p>
        </div>
        
        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label>Categor√≠a de Margen</label>
                    <select id="margin-filter">
                        <option value="">Todos</option>
                        <option value="high">Alto (>40%)</option>
                        <option value="medium">Medio (20-40%)</option>
                        <option value="low">Bajo (<20%)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Estado de Mapeo</label>
                    <select id="match-filter">
                        <option value="">Todos</option>
                        <option value="matched">Mapeados</option>
                        <option value="unmatched">Sin Mapear</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Posici√≥n en Mercado</label>
                    <select id="position-filter">
                        <option value="">Todos</option>
                        <option value="Cheapest">M√°s Barato</option>
                        <option value="Middle">Medio</option>
                        <option value="Most Expensive">M√°s Caro</option>
                    </select>
                </div>
            </div>
            <div>
                <button onclick="exportToCSV()" class="btn-success">üì• Exportar CSV</button>
                <button onclick="exportToHTML()" class="btn-success" style="background-color: #9b59b6;">üìÑ Exportar HTML</button>
                <button onclick="refreshData()">üîÑ Actualizar</button>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando datos...</p>
        </div>
        
        <table id="priceTable" class="display" style="display: none;">
            <thead>
                <tr>
                    <th>C√≥digo Dialfa</th>
                    <th>Descripci√≥n</th>
                    <th>Precio Dialfa</th>
                    <th>Precio c/ Descuento</th>
                    <th>Producto Citizen</th>
                    <th>Cantidad Total</th>
                    <th>FOB Min</th>
                    <th>FOB Max</th>
                    <th>FOB Ponderado</th>
                    <th>FOB Pond. + Nac.</th>
                    <th>Rentabilidad %</th>
                    <th>Margen Bruto %</th>
                    <th>Match Cintolo</th>
                    <th>Precio Cintolo</th>
                    <th>Dif vs Cintolo</th>
                    <th>Match Zaloze</th>
                    <th>Precio Zaloze</th>
                    <th>Dif vs Zaloze</th>
                    <th>Posici√≥n Mercado</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        let dataTable;
        let allData = [];
        
        function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('priceTable').style.display = 'none';
            
            // Get pricing configuration parameters
            const discountPercent = document.getElementById('discount-percent').value;
            const nationalizationPercent = document.getElementById('nationalization-percent').value;
            const cintoloDiscount = document.getElementById('cintolo-discount').value;
            const zalozeDiscount = document.getElementById('zaloze-discount').value;
            
            const url = `/api/data?discount_percent=${discountPercent}&nationalization_percent=${nationalizationPercent}&cintolo_discount=${cintoloDiscount}&zaloze_discount=${zalozeDiscount}`;
            
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    allData = result.data || [];
                    
                    // Display errors if any
                    if (result.errors && result.errors.length > 0) {
                        displayErrors(result.errors);
                    }
                    
                    // Update summary cards
                    updateSummary(result.summary);
                    
                    // Initialize or update DataTable
                    initializeDataTable(allData);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('priceTable').style.display = 'table';
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('loading').innerHTML = 
                        '<p style="color: red;">Error cargando datos: ' + error + '</p>';
                });
        }
        
        function applyPricingConfig() {
            // Reload data with new pricing configuration
            loadData();
        }
        
        function displayErrors(errors) {
            const container = document.getElementById('errors-container');
            container.innerHTML = `
                <div class="errors">
                    <h3>‚ö†Ô∏è Advertencias durante la carga de datos</h3>
                    <ul>
                        ${errors.map(err => `<li>${err}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        function updateSummary(summary) {
            document.getElementById('total-products').textContent = summary.total_products || 0;
            document.getElementById('matched-products').textContent = summary.matched_products || 0;
            document.getElementById('unmatched-citizen').textContent = summary.unmatched_citizen || 0;
            document.getElementById('matched-cintolo').textContent = summary.matched_cintolo || 0;
            document.getElementById('unmatched-cintolo').textContent = summary.unmatched_cintolo || 0;
            document.getElementById('matched-zaloze').textContent = summary.matched_zaloze || 0;
            document.getElementById('unmatched-zaloze').textContent = summary.unmatched_zaloze || 0;
            document.getElementById('avg-margin').innerHTML = 
                (summary.average_margin || 0).toFixed(1) + '<small>%</small>';
        }
        
        function initializeDataTable(data) {
            if (dataTable) {
                dataTable.destroy();
            }
            
            const tbody = document.querySelector('#priceTable tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // Apply margin category class to entire row
                if (row.margin_category) {
                    tr.className = `margin-${row.margin_category}`;
                }
                
                // USE VALUES FROM BACKEND - do NOT recalculate here
                // The backend already calculated everything with the correct parameters
                const precioConDescuento = row.precio_con_descuento;
                const ciudadanoNacionalizado = row.citizen_precio_nacionalizado;
                
                // Use backend-calculated margins directly
                const rentabilidadPercent = row.markup_percent;  // Markup % = Rentabilidad
                const margenBrutoPercent = row.margin_percent;   // Margin % = Margen Bruto
                
                tr.innerHTML = `
                    <td>${row.codigo || '-'}</td>
                    <td>${row.descripcion || '-'}</td>
                    <td class="price">$${formatNumber(row.dialfa_precio)}</td>
                    <td class="price">${precioConDescuento ? '$' + formatNumber(precioConDescuento) : '-'}</td>
                    <td>${row.citizen_producto || '-'}</td>
                    <td class="price" style="text-align: center;">${row.cantidad ? Math.round(row.cantidad) + ' uds' : '-'}</td>
                    <td class="price">$${formatNumber(row.precio_fob_min)}</td>
                    <td class="price">$${formatNumber(row.precio_fob_max)}</td>
                    <td class="price">$${formatNumber(row.precio_fob_ponderado)}</td>
                    <td class="price">${ciudadanoNacionalizado ? '$' + formatNumber(ciudadanoNacionalizado) : '-'}</td>
                    <td class="price">${rentabilidadPercent !== null ? formatNumber(rentabilidadPercent) + '%' : '-'}</td>
                    <td class="price">${margenBrutoPercent !== null ? formatNumber(margenBrutoPercent) + '%' : '-'}</td>
                    <td class="description" title="${row.cintolo_descripcion || 'Sin match'}">${row.cintolo_descripcion || '-'}</td>
                    <td class="price">${row.cintolo_precio ? '$' + formatNumber(row.cintolo_precio) : '-'}</td>
                    <td class="price">${row.diff_percent_cintolo ? formatNumber(row.diff_percent_cintolo) + '%' : '-'}</td>
                    <td class="description" title="${row.zaloze_descripcion || 'Sin match'}">${row.zaloze_descripcion || '-'}</td>
                    <td class="price">${row.zaloze_precio ? '$' + formatNumber(row.zaloze_precio) : '-'}</td>
                    <td class="price">${row.diff_percent_zaloze ? formatNumber(row.diff_percent_zaloze) + '%' : '-'}</td>
                    <td class="position-${row.market_position ? row.market_position.toLowerCase().replace(' ', '-') : 'na'}">
                        ${row.market_position || 'N/A'}
                    </td>
                    <td>
                        <span class="badge badge-${row.match_status === 'Unmatched' ? 'danger' : 'success'}">
                            ${row.match_status || 'Unknown'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            dataTable = $('#priceTable').DataTable({
                paging: false,  // Disable pagination - show all rows
                order: [[7, 'asc']],  // Sort by margin % ascending (column index 7 now)
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                scrollY: '600px',  // Add vertical scroll
                scrollCollapse: true
            });
            
            // Apply filters
            applyFilters();
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '-';
            }
            return parseFloat(num).toFixed(2);
        }
        
        function applyFilters() {
            if (!dataTable) return;
            
            const marginFilter = document.getElementById('margin-filter').value;
            const matchFilter = document.getElementById('match-filter').value;
            const positionFilter = document.getElementById('position-filter').value;
            
            $.fn.dataTable.ext.search = [];
            
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const rowData = allData[dataIndex];
                
                // Margin filter
                if (marginFilter && rowData.margin_category !== marginFilter) {
                    return false;
                }
                
                // Match filter
                if (matchFilter === 'matched' && rowData.match_status === 'Unmatched') {
                    return false;
                }
                if (matchFilter === 'unmatched' && rowData.match_status !== 'Unmatched') {
                    return false;
                }
                
                // Position filter
                if (positionFilter && rowData.market_position !== positionFilter) {
                    return false;
                }
                
                return true;
            });
            
            dataTable.draw();
        }
        
        function exportToCSV() {
            const csvContent = convertToCSV(allData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'comparacion_precios_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportToHTML() {
            // Get current pricing configuration
            const discountPercent = document.getElementById('discount-percent').value;
            const nationalizationPercent = document.getElementById('nationalization-percent').value;
            const cintoloDiscount = document.getElementById('cintolo-discount').value;
            const zalozeDiscount = document.getElementById('zaloze-discount').value;
            
            // Get current filters
            const marginFilter = document.getElementById('margin-filter').value;
            const matchFilter = document.getElementById('match-filter').value;
            const positionFilter = document.getElementById('position-filter').value;
            
            // Filter data based on current filters (same logic as applyFilters)
            const filteredData = allData.filter(rowData => {
                // Margin filter
                if (marginFilter && rowData.margin_category !== marginFilter) {
                    return false;
                }
                
                // Match filter
                if (matchFilter === 'matched' && rowData.match_status === 'Unmatched') {
                    return false;
                }
                if (matchFilter === 'unmatched' && rowData.match_status !== 'Unmatched') {
                    return false;
                }
                
                // Position filter
                if (positionFilter && rowData.market_position !== positionFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Send filtered data to backend via POST
            fetch('/api/export/html', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: filteredData,
                    discount_percent: discountPercent,
                    nationalization_percent: nationalizationPercent,
                    cintolo_discount: cintoloDiscount,
                    zaloze_discount: zalozeDiscount,
                    filters: {
                        margin: marginFilter,
                        match: matchFilter,
                        position: positionFilter
                    }
                })
            })
            .then(response => response.blob())
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'comparacion_precios_filtrado_' + new Date().toISOString().split('T')[0] + '.html');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error exporting HTML:', error);
                alert('Error al exportar HTML: ' + error);
            });
        }
        
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const val = row[header];
                    return val === null || val === undefined ? '' : `"${val}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function refreshData() {
            fetch('/api/refresh')
                .then(() => loadData())
                .catch(error => console.error('Error refreshing:', error));
        }
        
        // Event listeners
        document.getElementById('margin-filter').addEventListener('change', applyFilters);
        document.getElementById('match-filter').addEventListener('change', applyFilters);
        document.getElementById('position-filter').addEventListener('change', applyFilters);
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>

